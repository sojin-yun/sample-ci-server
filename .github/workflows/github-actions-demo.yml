name: Likelion CI Test
run-name: ${{ github.actor }} is testing out GitHub Actions ğŸš€
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            dist
            package.json
            package-lock.json
            tsconfig.json
            tsconfig.build.json

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      # 1. ë¹Œë“œ ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ (checkout ëŒ€ì‹  ì‚¬ìš©)
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-output

      # 2. SSH í‚¤ ì„¤ì •
      - name: Configure AWS credentials
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_SSH_KEY }}" > ~/.ssh/aws.key
          chmod 600 ~/.ssh/aws.key
          ssh-keyscan -H "${{ secrets.EC2_PUBLIC_IP }}" >> ~/.ssh/known_hosts

      # 3. ë°°í¬ ë° ì„œë²„ ì¬ì‹œì‘ (EC2_USER: Amazon Linux = ec2-user, Ubuntu = ubuntu)
      - name: Deploy to EC2
        env:
          EC2_PUBLIC_IP: ${{ secrets.EC2_PUBLIC_IP }}
          EC2_USER: ${{ secrets.EC2_USER || 'ec2-user' }}
        run: |
          # ì›ê²© ë””ë ‰í† ë¦¬ ìƒì„±
          ssh -i ~/.ssh/aws.key $EC2_USER@$EC2_PUBLIC_IP "mkdir -p ~/sample-server"

          # í•„ìš”í•œ íŒŒì¼ ì „ì†¡ (dist í´ë”ì™€ ì„¤ì • íŒŒì¼ë“¤)
          scp -i ~/.ssh/aws.key -r \
            dist \
            package.json \
            package-lock.json \
            $EC2_USER@$EC2_PUBLIC_IP:~/sample-server/

          # EC2 ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë  ëª…ë ¹ì–´ (Heredoc ë°©ì‹)
          ssh -i ~/.ssh/aws.key $EC2_USER@$EC2_PUBLIC_IP << 'ENDSSH'
            cd ~/sample-server
            
            # ì˜ì¡´ì„± ì„¤ì¹˜ (ë°°í¬ìš©)
            npm ci --omit=dev
            
            # PM2ë¡œ ì„œë²„ ì¬ì‹œì‘ (ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì‚­ì œ í›„ ìƒˆë¡œ ì‹œì‘)
            pm2 delete sample-ci-server || true
            pm2 start dist/main.js --name sample-server
            
            # ì„¤ì • ì €ì¥ (ì¸ìŠ¤í„´ìŠ¤ ì¬ë¶€íŒ… ì‹œ ëŒ€ë¹„)
            pm2 save
          ENDSSH

      - name: Final Status
        run: echo "ğŸ This job's status is ${{ job.status }}."